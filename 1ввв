<?php
// ============================================================================
// üì¶ –°–û–ó–î–ê–¢–ï–õ–¨ –¢–û–í–ê–†–û–í v3.0 - –ß–ò–°–¢–ê–Ø –í–ï–†–°–ò–Ø (–ë–ï–ó –ò–ò –ö–û–î–ê)
// –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –ò–ò —á–µ—Ä–µ–∑ functions.php
// ============================================================================

require_once '../functions.php';
$categories = getCategories();

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
if ($_SERVER['REQUEST_METHOD'] === 'POST' && !isset($_POST['ai_action'])) {
    $productData = [
        'name' => trim($_POST['name'] ?? ''),
        'latin_name' => trim($_POST['latin_name'] ?? ''),
        'price' => (float)($_POST['price'] ?? 0),
        'old_price' => (float)($_POST['old_price'] ?? 0),
        'description' => trim($_POST['description'] ?? ''),
        'short_description' => trim($_POST['short_description'] ?? ''),
        'category_id' => (int)($_POST['category_id'] ?? 0),
        'difficulty' => trim($_POST['difficulty'] ?? '–ª–µ–≥–∫–æ'),
        'care_level' => trim($_POST['care_level'] ?? '–Ω–∞—á–∏–Ω–∞—é—â–∏–π'),
        'size' => trim($_POST['size'] ?? ''),
        'temperature' => trim($_POST['temperature'] ?? ''),
        'ph_level' => trim($_POST['ph_level'] ?? ''),
        'lighting' => trim($_POST['lighting'] ?? ''),
        'tags' => trim($_POST['tags'] ?? ''),
        'meta_title' => trim($_POST['meta_title'] ?? ''),
        'meta_description' => trim($_POST['meta_description'] ?? ''),
        'stock_quantity' => (int)($_POST['stock_quantity'] ?? 0),
        'sku' => trim($_POST['sku'] ?? generateRandomSKU()),
        'manufacturer' => trim($_POST['manufacturer'] ?? ''),
        'country' => trim($_POST['country'] ?? ''),
        'warranty_months' => (int)($_POST['warranty_months'] ?? 0),
        'main_image' => $_POST['main_image'] ?? '',
        'gallery' => $_POST['gallery'] ?? '[]',
        'badges' => $_POST['badges'] ?? '[]'
    ];

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    $errors = [];
    if (empty($productData['name'])) $errors[] = '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ';
    if (empty($productData['description'])) $errors[] = '–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ';
    if ($productData['price'] <= 0) $errors[] = '–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è';
    if ($productData['category_id'] <= 0) $errors[] = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é';

    if (empty($errors)) {
        $result = saveProduct($productData);
        if ($result['success']) {
            $success = '–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! ID: ' . $result['product_id'];
            $_POST = []; // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        } else {
            $error = '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞: ' . ($result['error'] ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
    } else {
        $error = '–ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏: ' . implode(', ', $errors);
    }
}

function generateRandomSKU() {
    return 'PROD_' . strtoupper(substr(uniqid(), -8));
}
?>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì¶ –°–æ–∑–¥–∞—Ç–µ–ª—å –¢–æ–≤–∞—Ä–æ–≤ v3.0 | –ê–∫–≤–∞–°–±–æ—Ä</title>

    <!-- Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #667eea;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #06d6a0;
            --warning-color: #ffd60a;
            --danger-color: #f72585;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .main-header {
            background: var(--primary-gradient);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .header-title {
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.9);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }

        .card-header {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 1.5rem;
            border-radius: 20px 20px 0 0 !important;
        }

        .form-control, .form-select {
            border-radius: 15px;
            border: 2px solid #e9ecef;
            padding: 12px 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn {
            border-radius: 15px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: var(--primary-gradient);
        }

        .btn-success {
            background: linear-gradient(135deg, #06d6a0, #00b09b);
        }

        .image-upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 20px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-upload-area:hover {
            border-color: var(--primary-color);
            background: #e3f2fd;
        }

        .gallery-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 1rem;
        }

        .gallery-item {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .live-preview {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            position: sticky;
            top: 2rem;
        }

        .ai-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--primary-color);
        }

        @media (max-width: 768px) {
            .header-title { font-size: 2rem; }
            .card { margin-bottom: 1rem; }
        }
    </style>
</head>
<body>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
<header class="main-header">
    <div class="container">
        <h1 class="header-title">
            <i class="fas fa-box-open me-3"></i>
            üì¶ –°–æ–∑–¥–∞—Ç–µ–ª—å –¢–æ–≤–∞—Ä–æ–≤ v3.0
        </h1>
        <p class="lead mb-0">
            ‚ú® –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø–æ—Ç—Ä—è—Å–∞—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –ò–ò –ø–æ–º–æ—â–Ω–∏–∫–∞
        </p>
    </div>
</header>

<div class="container-fluid">

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <?php if (isset($success)): ?>
        <div class="alert alert-success alert-dismissible fade show">
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle me-3 fs-4"></i>
                <div>
                    <strong>üéâ –£—Å–ø–µ—Ö!</strong><br>
                    <?= $success ?>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <?php endif; ?>

    <?php if (isset($error)): ?>
        <div class="alert alert-danger alert-dismissible fade show">
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
                <div>
                    <strong>‚ùå –û—à–∏–±–∫–∞!</strong><br>
                    <?= $error ?>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <?php endif; ?>

    <div class="row">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
        <div class="col-xl-8 col-lg-7">
            <form method="POST" id="productForm" enctype="multipart/form-data">

                <!-- –ò–ò –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="ai-panel">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-robot me-2"></i>
                            ü§ñ –ò–ò –ü–æ–º–æ—â–Ω–∏–∫
                        </h5>
                        <div class="btn-group">
                            <button type="button" class="btn btn-primary" onclick="aiGenerateAll()">
                                <i class="fas fa-magic me-1"></i>–ü–æ–ª–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
                            </button>
                            <button type="button" class="btn btn-success" onclick="aiImproveProduct()">
                                <i class="fas fa-wand-magic-sparkles me-1"></i>–£–ª—É—á—à–∏—Ç—å –≤—Å—ë
                            </button>
                            <button type="button" class="btn btn-info" onclick="aiAnalyzeProduct()">
                                <i class="fas fa-search me-1"></i>–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                    </div>
                </div>

                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="m-0">
                            <i class="fas fa-info-circle me-2"></i>
                            –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–∞
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">
                                        –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ <span class="text-danger">*</span>
                                        <button type="button" class="btn btn-sm btn-outline-primary ms-1" onclick="aiGenerateName()">
                                            <i class="fas fa-robot"></i>
                                        </button>
                                    </label>
                                    <input type="text" class="form-control form-control-lg" name="name" id="productName" 
                                           required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–Ω—É–±–∏–∞—Å –Ω–∞–Ω–∞ - –Ω–µ–ø—Ä–∏—Ö–æ—Ç–ª–∏–≤–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">–ê—Ä—Ç–∏–∫—É–ª (SKU)</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="sku" id="productSKU" placeholder="–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è">
                                        <button type="button" class="btn btn-outline-secondary" onclick="generateNewSKU()">
                                            <i class="fas fa-sync"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">–ö–∞—Ç–µ–≥–æ—Ä–∏—è <span class="text-danger">*</span></label>
                                    <select class="form-select" name="category_id" id="productCategory" required>
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                        <?php foreach ($categories as $category): ?>
                                            <option value="<?= $category['id'] ?>"><?= htmlspecialchars($category['name']) ?></option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">
                                        –¶–µ–Ω–∞ <span class="text-danger">*</span>
                                        <button type="button" class="btn btn-sm btn-outline-warning ms-1" onclick="aiSuggestPrice()">
                                            <i class="fas fa-robot"></i>
                                        </button>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="price" id="productPrice" 
                                               required min="0" step="0.01" placeholder="0">
                                        <span class="input-group-text">‚ÇΩ</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="old_price" id="productOldPrice" 
                                               min="0" step="0.01" placeholder="0">
                                        <span class="input-group-text">‚ÇΩ</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –û–ø–∏—Å–∞–Ω–∏—è -->
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="m-0">
                                <i class="fas fa-file-text me-2"></i>
                                –û–ø–∏—Å–∞–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–Ω—Ç
                            </h6>
                            <button type="button" class="btn btn-sm btn-light" onclick="aiGenerateDescription()">
                                <i class="fas fa-robot me-1"></i>–ò–ò –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" name="short_description" id="productShortDescription" 
                                      rows="2" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="description" id="productDescription" 
                                      rows="8" required placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..."></textarea>
                        </div>

                        <div class="mb-0">
                            <label class="form-label fw-semibold">
                                –¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
                                <button type="button" class="btn btn-sm btn-outline-info ms-1" onclick="aiGenerateTags()">
                                    <i class="fas fa-hashtag"></i>
                                </button>
                            </label>
                            <input type="text" class="form-control" name="tags" id="productTags" 
                                   placeholder="–∞–∫–≤–∞—Ä–∏—É–º, —Ä–∞—Å—Ç–µ–Ω–∏—è, –¥–µ–∫–æ—Ä">
                        </div>
                    </div>
                </div>

                <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="m-0">
                            <i class="fas fa-images me-2"></i>
                            –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-6 mb-4">
                                <label class="form-label fw-semibold">–û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ <span class="text-danger">*</span></label>
                                <div class="image-upload-area" id="mainImageUpload">
                                    <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                                    <h5>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—é–¥–∞</h5>
                                    <p class="text-muted mb-3">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</p>
                                    <button type="button" class="btn btn-primary">
                                        <i class="fas fa-folder-open me-1"></i>–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                                    </button>
                                </div>
                                <input type="hidden" name="main_image" id="mainImagePath">
                            </div>

                            <div class="col-lg-6 mb-4">
                                <label class="form-label fw-semibold">–ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</label>
                                <div class="image-upload-area" id="galleryUpload">
                                    <i class="fas fa-images fa-4x text-primary mb-3"></i>
                                    <h6>–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞</h6>
                                    <p class="text-muted mb-3">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤</p>
                                    <button type="button" class="btn btn-primary">
                                        <i class="fas fa-folder-open me-1"></i>–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
                                    </button>
                                </div>
                                <div id="galleryPreview" class="gallery-preview mt-3"></div>
                                <input type="hidden" name="gallery" id="galleryPaths" value="[]">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="m-0">
                            <i class="fas fa-cogs me-2"></i>
                            –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">–†–∞–∑–º–µ—Ä</label>
                                <input type="text" class="form-control" name="size" placeholder="10-15 —Å–º">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</label>
                                <input type="text" class="form-control" name="temperature" placeholder="22-26¬∞C">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">pH —É—Ä–æ–≤–µ–Ω—å</label>
                                <input type="text" class="form-control" name="ph_level" placeholder="6.0-7.5">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">–û—Å–≤–µ—â–µ–Ω–∏–µ</label>
                                <select class="form-select" name="lighting">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                                    <option value="—Å–ª–∞–±–æ–µ">üí° –°–ª–∞–±–æ–µ</option>
                                    <option value="—Å—Ä–µ–¥–Ω–µ–µ">üí°üí° –°—Ä–µ–¥–Ω–µ–µ</option>
                                    <option value="—è—Ä–∫–æ–µ">üí°üí°üí° –Ø—Ä–∫–æ–µ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <div>
                                <button type="button" class="btn btn-outline-secondary me-2" onclick="saveAsDraft()">
                                    <i class="fas fa-save me-1"></i>–ß–µ—Ä–Ω–æ–≤–∏–∫
                                </button>
                                <button type="button" class="btn btn-outline-info me-2" onclick="previewProduct()">
                                    <i class="fas fa-eye me-1"></i>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-secondary me-2" onclick="resetForm()">
                                    <i class="fas fa-undo me-1"></i>–°–±—Ä–æ—Å–∏—Ç—å
                                </button>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-rocket me-1"></i>–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="col-xl-4 col-lg-5">
            <!-- –ñ–∏–≤–æ–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
            <div class="live-preview mb-4">
                <h6 class="mb-3">
                    <i class="fas fa-eye me-2"></i>
                    –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                </h6>
                <div class="text-center">
                    <div class="ratio ratio-1x1 bg-light rounded mb-3">
                        <img id="previewImage" class="d-none" style="object-fit: cover;">
                        <i class="fas fa-fish fa-3x text-muted d-flex align-items-center justify-content-center" id="previewPlaceholder"></i>
                    </div>
                    <h6 id="previewName">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h6>
                    <p class="text-muted small" id="previewDescription">–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="h5 text-success mb-0" id="previewPrice">0 ‚ÇΩ</span>
                        <small class="text-muted" id="previewCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</small>
                    </div>
                    <button class="btn btn-success w-100 mt-3">
                        <i class="fas fa-shopping-cart me-2"></i>–ö—É–ø–∏—Ç—å
                    </button>
                </div>
            </div>

            <!-- SEO –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="m-0">
                            <i class="fas fa-search me-2"></i>
                            SEO –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
                        </h6>
                        <button type="button" class="btn btn-sm btn-light" onclick="aiOptimizeSEO()">
                            <i class="fas fa-robot me-1"></i>–ò–ò SEO
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label small">Meta Title</label>
                        <input type="text" class="form-control form-control-sm" name="meta_title" maxlength="60">
                    </div>
                    <div class="mb-0">
                        <label class="form-label small">Meta Description</label>
                        <textarea class="form-control form-control-sm" name="meta_description" rows="3" maxlength="160"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ============================================================================
// üì¶ –°–û–ó–î–ê–¢–ï–õ–¨ –¢–û–í–ê–†–û–í v3.0 - JAVASCRIPT (–ë–ï–ó –ò–ò –ö–û–î–ê)
// ============================================================================

let galleryImages = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    console.log('üì¶ –°–æ–∑–¥–∞—Ç–µ–ª—å —Ç–æ–≤–∞—Ä–æ–≤ v3.0 –∑–∞–≥—Ä—É–∂–µ–Ω');

    initializeFormHandlers();
    initializeImageUploads();
    initializeLivePreview();

    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ SKU
    if (!document.getElementById('productSKU').value) {
        generateNewSKU();
    }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Ñ–æ—Ä–º—ã
function initializeFormHandlers() {
    const form = document.getElementById('productForm');
    const inputs = form.querySelectorAll('input, select, textarea');

    inputs.forEach(input => {
        input.addEventListener('input', updateLivePreview);
        input.addEventListener('change', updateLivePreview);
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
function initializeImageUploads() {
    const mainUpload = document.getElementById('mainImageUpload');
    const galleryUpload = document.getElementById('galleryUpload');

    if (mainUpload) setupImageUpload(mainUpload, 'main');
    if (galleryUpload) setupImageUpload(galleryUpload, 'gallery');
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
function setupImageUpload(element, type) {
    element.addEventListener('click', () => selectFiles(type));

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        element.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
        });
    });

    element.addEventListener('dragover', () => element.style.background = '#e3f2fd');
    element.addEventListener('dragleave', () => element.style.background = '');
    element.addEventListener('drop', (e) => {
        element.style.background = '';
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) processFiles(files, type);
    });
}

// –í—ã–±–æ—Ä —Ñ–∞–π–ª–æ–≤
function selectFiles(type) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.multiple = type === 'gallery';

    input.onchange = (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) processFiles(files, type);
    };

    input.click();
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
function processFiles(files, type) {
    files.forEach(file => {
        if (!file.type.startsWith('image/')) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            if (type === 'main') {
                setMainImage(e.target.result);
            } else {
                addToGallery(e.target.result);
            }
            updateLivePreview();
        };
        reader.readAsDataURL(file);
    });
}

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function setMainImage(imageSrc) {
    const mainUpload = document.getElementById('mainImageUpload');
    const mainPath = document.getElementById('mainImagePath');

    mainUpload.innerHTML = `
        <img src="${imageSrc}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 15px;">
        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2" onclick="removeMainImage()">
            <i class="fas fa-times"></i>
        </button>
    `;

    mainPath.value = imageSrc;
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –≥–∞–ª–µ—Ä–µ—é
function addToGallery(imageSrc) {
    galleryImages.push(imageSrc);
    updateGalleryPreview();
    updateGalleryInput();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –≥–∞–ª–µ—Ä–µ–∏
function updateGalleryPreview() {
    const preview = document.getElementById('galleryPreview');

    preview.innerHTML = galleryImages.map((src, index) => `
        <div class="gallery-item">
            <img src="${src}" style="width: 100%; height: 150px; object-fit: cover;">
            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                    onclick="removeFromGallery(${index})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è –≥–∞–ª–µ—Ä–µ–∏
function updateGalleryInput() {
    document.getElementById('galleryPaths').value = JSON.stringify(galleryImages);
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏
function removeFromGallery(index) {
    galleryImages.splice(index, 1);
    updateGalleryPreview();
    updateGalleryInput();
}

// –£–¥–∞–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function removeMainImage() {
    const mainUpload = document.getElementById('mainImageUpload');
    const mainPath = document.getElementById('mainImagePath');

    mainUpload.innerHTML = `
        <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
        <h5>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—é–¥–∞</h5>
        <p class="text-muted mb-3">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</p>
        <button type="button" class="btn btn-primary">
            <i class="fas fa-folder-open me-1"></i>–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
        </button>
    `;

    mainPath.value = '';
    updateLivePreview();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∂–∏–≤–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
function initializeLivePreview() {
    updateLivePreview();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∂–∏–≤–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
function updateLivePreview() {
    const name = document.getElementById('productName').value || '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞';
    const price = document.getElementById('productPrice').value || '0';
    const description = document.getElementById('productShortDescription').value || 
                       document.getElementById('productDescription').value || '–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...';
    const categorySelect = document.getElementById('productCategory');
    const category = categorySelect.selectedOptions[0]?.text || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è';

    document.getElementById('previewName').textContent = name;
    document.getElementById('previewPrice').textContent = formatPrice(price);
    document.getElementById('previewCategory').textContent = category;

    const previewDesc = document.getElementById('previewDescription');
    previewDesc.textContent = description.length > 100 ? 
        description.substring(0, 100) + '...' : description;

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const mainImage = document.getElementById('mainImagePath').value;
    const previewImg = document.getElementById('previewImage');
    const previewPlaceholder = document.getElementById('previewPlaceholder');

    if (mainImage) {
        previewImg.src = mainImage;
        previewImg.classList.remove('d-none');
        previewPlaceholder.style.display = 'none';
    } else {
        previewImg.classList.add('d-none');
        previewPlaceholder.style.display = 'flex';
    }
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ SKU
function generateNewSKU() {
    const newSKU = 'PROD_' + Math.random().toString(36).substr(2, 8).toUpperCase();
    document.getElementById('productSKU').value = newSKU;
    showNotification('üîÑ –ù–æ–≤—ã–π SKU —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!', 'success');
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫
function saveAsDraft() {
    const formData = new FormData(document.getElementById('productForm'));
    const draftData = {};

    formData.forEach((value, key) => {
        draftData[key] = value;
    });

    localStorage.setItem('product_draft', JSON.stringify(draftData));
    showNotification('üíæ –ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
}

// –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–∞
function previewProduct() {
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º
    showNotification('üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–∫—Ä—ã—Ç!', 'info');
}

// –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
function resetForm() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É?')) {
        document.getElementById('productForm').reset();
        galleryImages = [];
        updateGalleryPreview();
        updateGalleryInput();
        document.getElementById('mainImagePath').value = '';
        removeMainImage();
        updateLivePreview();
        showNotification('üßπ –§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞!', 'info');
    }
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
function formatPrice(price) {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0
    }).format(parseFloat(price) || 0);
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type = 'success') {
    const alertClass = type === 'success' ? 'alert-success' : 
                       type === 'error' ? 'alert-danger' : 'alert-info';

    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// ============================================================================
// –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ò –ò–ù–¢–ï–ì–†–ê–¶–ò–ò (–í–´–ó–´–í–ê–Æ–¢ –§–£–ù–ö–¶–ò–ò –ò–ó functions.php)
// ============================================================================

// –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–∑—ã–≤–∞—é—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ò–ò —Ñ—É–Ω–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ AJAX
async function aiGenerateAll() {
    await callAIFunction('generate_all');
}

async function aiImproveProduct() {
    await callAIFunction('improve_product');
}

async function aiAnalyzeProduct() {
    await callAIFunction('analyze_product');
}

async function aiGenerateName() {
    await callAIFunction('generate_name');
}

async function aiGenerateDescription() {
    await callAIFunction('generate_description');
}

async function aiSuggestPrice() {
    await callAIFunction('suggest_price');
}

async function aiGenerateTags() {
    await callAIFunction('generate_tags');
}

async function aiOptimizeSEO() {
    await callAIFunction('optimize_seo');
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑–æ–≤–∞ –ò–ò
async function callAIFunction(action) {
    try {
        showNotification('ü§ñ –ò–ò –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å...', 'info');

        const formData = new FormData();
        formData.append('ai_action', action);
        formData.append('product_name', document.getElementById('productName').value);
        formData.append('category', document.getElementById('productCategory').value);
        formData.append('description', document.getElementById('productDescription').value);

        const response = await fetch('', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç –ò–ò
            if (result.name) document.getElementById('productName').value = result.name;
            if (result.description) document.getElementById('productDescription').value = result.description;
            if (result.short_description) document.getElementById('productShortDescription').value = result.short_description;
            if (result.price) document.getElementById('productPrice').value = result.price;
            if (result.old_price) document.getElementById('productOldPrice').value = result.old_price;
            if (result.tags) document.getElementById('productTags').value = result.tags;
            if (result.meta_title) document.querySelector('[name="meta_title"]').value = result.meta_title;
            if (result.meta_description) document.querySelector('[name="meta_description"]').value = result.meta_description;

            updateLivePreview();
            showNotification('‚ú® –ò–ò —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–ª –¥–∞–Ω–Ω—ã–µ!', 'success');
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ò–ò: ' + result.message, 'error');
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ò–ò:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ò–ò', 'error');
    }
}

console.log('‚úÖ –°–æ–∑–¥–∞—Ç–µ–ª—å —Ç–æ–≤–∞—Ä–æ–≤ v3.0 –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');
</script>

</body>
</html>
