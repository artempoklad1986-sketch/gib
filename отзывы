<?php
// Не подключаем functions.php повторно, он уже подключен в admin/index.php

// Обработка AJAX запросов для отзывов
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {
    header('Content-Type: application/json; charset=utf-8');

    try {
        switch ($_POST['action']) {
            case 'save_review':
                $reviewData = [
                    'id' => $_POST['id'] ?? generateUniqueId(),
                    'product_id' => (int)($_POST['product_id'] ?? 0),
                    'customer_name' => trim($_POST['customer_name'] ?? ''),
                    'customer_email' => trim($_POST['customer_email'] ?? ''),
                    'rating' => (int)($_POST['rating'] ?? 0),
                    'title' => trim($_POST['title'] ?? ''),
                    'comment' => trim($_POST['comment'] ?? ''),
                    'status' => $_POST['status'] ?? 'pending',
                    'created_at' => $_POST['created_at'] ?? date('Y-m-d H:i:s'),
                    'updated_at' => date('Y-m-d H:i:s')
                ];

                $result = saveReview($reviewData);
                echo json_encode($result);
                break;

            case 'update_review_status':
                $id = $_POST['id'] ?? '';
                $status = $_POST['status'] ?? 'pending';
                $result = updateReviewStatus($id, $status);
                echo json_encode([
                    'success' => $result,
                    'message' => $result ? 'Статус отзыва обновлен' : 'Ошибка обновления статуса'
                ]);
                break;

            case 'delete_review':
                $id = $_POST['id'] ?? '';
                $result = deleteReview($id);
                echo json_encode([
                    'success' => $result,
                    'message' => $result ? 'Отзыв удален' : 'Ошибка удаления отзыва'
                ]);
                break;

            case 'get_review':
                $id = $_POST['id'] ?? '';
                $review = getReviewById($id);
                if ($review) {
                    echo json_encode(['success' => true, 'review' => $review]);
                } else {
                    echo json_encode(['success' => false, 'message' => 'Отзыв не найден']);
                }
                break;
        }
    } catch (Exception $e) {
        echo json_encode(['success' => false, 'message' => 'Ошибка сервера: ' . $e->getMessage()]);
    }
    exit;
}

// Получение данных для отображения
$reviews = getAllReviews();
$products = getAllProducts();
$stats = getReviewsStats();

// Функция для получения статистики отзывов
function getReviewsStats() {
    $reviews = getAllReviews();
    $total = count($reviews);
    $pending = count(array_filter($reviews, fn($r) => ($r['status'] ?? 'pending') === 'pending'));
    $approved = count(array_filter($reviews, fn($r) => ($r['status'] ?? 'pending') === 'approved'));
    $rejected = count(array_filter($reviews, fn($r) => ($r['status'] ?? 'pending') === 'rejected'));

    $avgRating = 0;
    if ($approved > 0) {
        $approvedReviews = array_filter($reviews, fn($r) => ($r['status'] ?? 'pending') === 'approved');
        $ratings = array_filter(array_column($approvedReviews, 'rating'), fn($r) => is_numeric($r) && $r > 0);
        if (!empty($ratings)) {
            $avgRating = array_sum($ratings) / count($ratings);
        }
    }

    return [
        'total' => $total,
        'pending' => $pending,
        'approved' => $approved,
        'rejected' => $rejected,
        'avg_rating' => round($avgRating, 1)
    ];
}
?>

<div class='page-header'>
    <div class='d-flex justify-content-between align-items-center'>
        <div>
            <h1><i class='fas fa-star me-2 text-warning'></i>Управление отзывами</h1>
            <p class='text-muted mb-0'>Модерация и управление отзывами покупателей</p>
        </div>
        <button class='btn btn-primary' onclick='showReviewModal()'>
            <i class='fas fa-plus me-2'></i>Добавить отзыв
        </button>
    </div>
</div>

<!-- Статистика отзывов -->
<div class='row mb-4'>
    <div class='col-md-3'>
        <div class='card stat-card h-100'>
            <div class='card-body text-center'>
                <div class='stat-icon bg-gradient-primary mx-auto'>
                    <i class='fas fa-comment-dots'></i>
                </div>
                <h3 class='text-dark'><?= $stats['total'] ?></h3>
                <p class='text-muted mb-0'>Всего отзывов</p>
            </div>
        </div>
    </div>
    <div class='col-md-3'>
        <div class='card stat-card h-100'>
            <div class='card-body text-center'>
                <div class='stat-icon bg-gradient-warning mx-auto'>
                    <i class='fas fa-clock'></i>
                </div>
                <h3 class='text-dark'><?= $stats['pending'] ?></h3>
                <p class='text-muted mb-0'>На модерации</p>
            </div>
        </div>
    </div>
    <div class='col-md-3'>
        <div class='card stat-card h-100'>
            <div class='card-body text-center'>
                <div class='stat-icon bg-gradient-success mx-auto'>
                    <i class='fas fa-check-circle'></i>
                </div>
                <h3 class='text-dark'><?= $stats['approved'] ?></h3>
                <p class='text-muted mb-0'>Одобренных</p>
            </div>
        </div>
    </div>
    <div class='col-md-3'>
        <div class='card stat-card h-100'>
            <div class='card-body text-center'>
                <div class='stat-icon bg-gradient-info mx-auto'>
                    <i class='fas fa-star'></i>
                </div>
                <h3 class='text-dark'><?= $stats['avg_rating'] ?></h3>
                <p class='text-muted mb-0'>Средняя оценка</p>
            </div>
        </div>
    </div>
</div>

<!-- Фильтры -->
<div class='content-card mb-4'>
    <div class='row g-3'>
        <div class='col-md-4'>
            <label class='form-label'>Фильтр по статусу:</label>
            <select class='form-select' id='statusFilter' onchange='filterReviews()'>
                <option value=''>Все отзывы</option>
                <option value='pending'>На модерации</option>
                <option value='approved'>Одобренные</option>
                <option value='rejected'>Отклоненные</option>
            </select>
        </div>
        <div class='col-md-4'>
            <label class='form-label'>Поиск:</label>
            <input type='text' class='form-control' id='searchInput' placeholder='Поиск по имени, email, отзыву...' onkeyup='filterReviews()'>
        </div>
        <div class='col-md-4'>
            <label class='form-label'>Рейтинг:</label>
            <select class='form-select' id='ratingFilter' onchange='filterReviews()'>
                <option value=''>Любой рейтинг</option>
                <option value='5'>5 звезд</option>
                <option value='4'>4 звезды</option>
                <option value='3'>3 звезды</option>
                <option value='2'>2 звезды</option>
                <option value='1'>1 звезда</option>
            </select>
        </div>
    </div>
</div>

<!-- Список отзывов -->
<div class='content-card'>
    <div class='table-responsive'>
        <table class='table table-hover' id='reviewsTable'>
            <thead class='table-light'>
                <tr>
                    <th>Товар</th>
                    <th>Покупатель</th>
                    <th>Рейтинг</th>
                    <th>Отзыв</th>
                    <th>Статус</th>
                    <th>Дата</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                <?php if (empty($reviews)): ?>
                    <tr>
                        <td colspan='7' class='text-center py-4'>
                            <i class='fas fa-comment-slash fa-3x text-muted mb-3 d-block'></i>
                            <h5>Отзывы не найдены</h5>
                            <p class='text-muted'>Пока нет ни одного отзыва</p>
                        </td>
                    </tr>
                <?php else: ?>
                    <?php foreach ($reviews as $review): ?>
                        <?php 
                        $product = getProductById($review['product_id'] ?? 0);
                        $productName = $product ? $product['name'] : 'Товар не найден';
                        ?>
                        <tr class='review-row' 
                            data-status='<?= htmlspecialchars($review['status'] ?? 'pending') ?>'
                            data-rating='<?= $review['rating'] ?? 0 ?>'
                            data-search='<?= htmlspecialchars(($review['customer_name'] ?? '') . ' ' . ($review['customer_email'] ?? '') . ' ' . ($review['comment'] ?? '')) ?>'>
                            <td>
                                <div class='fw-medium'><?= htmlspecialchars($productName) ?></div>
                                <small class='text-muted'>ID: <?= $review['product_id'] ?? 'N/A' ?></small>
                            </td>
                            <td>
                                <div class='fw-medium'><?= htmlspecialchars($review['customer_name'] ?? 'Аноним') ?></div>
                                <small class='text-muted'><?= htmlspecialchars($review['customer_email'] ?? '') ?></small>
                            </td>
                            <td>
                                <div class='d-flex'>
                                    <?php for ($i = 1; $i <= 5; $i++): ?>
                                        <i class='fas fa-star <?= $i <= ($review['rating'] ?? 0) ? 'text-warning' : 'text-muted' ?>'></i>
                                    <?php endfor; ?>
                                </div>
                                <small class='text-muted'><?= $review['rating'] ?? 0 ?>/5</small>
                            </td>
                            <td>
                                <div class='fw-medium'><?= htmlspecialchars($review['title'] ?? '') ?></div>
                                <div class='text-muted small'><?= htmlspecialchars(mb_substr($review['comment'] ?? '', 0, 50)) ?>...</div>
                            </td>
                            <td>
                                <?php
                                $statusMap = [
                                    'pending' => ['warning', 'На модерации'],
                                    'approved' => ['success', 'Одобрен'],
                                    'rejected' => ['danger', 'Отклонен']
                                ];
                                $status = $review['status'] ?? 'pending';
                                $statusInfo = $statusMap[$status] ?? ['secondary', 'Неизвестно'];
                                ?>
                                <span class='badge bg-<?= $statusInfo[0] ?>'><?= $statusInfo[1] ?></span>
                            </td>
                            <td>
                                <small><?= date('d.m.Y H:i', strtotime($review['created_at'] ?? 'now')) ?></small>
                            </td>
                            <td>
                                <div class='btn-group btn-group-sm'>
                                    <button class='btn btn-outline-primary btn-action' onclick='editReview("<?= $review['id'] ?>")' title='Редактировать'>
                                        <i class='fas fa-edit'></i>
                                    </button>
                                    <div class='btn-group'>
                                        <button class='btn btn-outline-success btn-action dropdown-toggle' data-bs-toggle='dropdown' title='Изменить статус'>
                                            <i class='fas fa-check'></i>
                                        </button>
                                        <ul class='dropdown-menu'>
                                            <li><a class='dropdown-item' onclick='updateStatus("<?= $review['id'] ?>", "approved")'>Одобрить</a></li>
                                            <li><a class='dropdown-item' onclick='updateStatus("<?= $review['id'] ?>", "pending")'>На модерацию</a></li>
                                            <li><a class='dropdown-item' onclick='updateStatus("<?= $review['id'] ?>", "rejected")'>Отклонить</a></li>
                                        </ul>
                                    </div>
                                    <button class='btn btn-outline-danger btn-action' onclick='deleteReview("<?= $review['id'] ?>")' title='Удалить'>
                                        <i class='fas fa-trash'></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</div>

<!-- Модальное окно редактирования отзыва -->
<div class='modal fade' id='reviewModal' tabindex='-1'>
    <div class='modal-dialog modal-lg'>
        <div class='modal-content'>
            <div class='modal-header bg-primary text-white'>
                <h5 class='modal-title' id='reviewModalTitle'>Добавить отзыв</h5>
                <button type='button' class='btn-close btn-close-white' data-bs-dismiss='modal'></button>
            </div>
            <form id='reviewForm'>
                <div class='modal-body'>
                    <input type='hidden' id='reviewId' name='id'>
                    <div class='row'>
                        <div class='col-md-6'>
                            <label class='form-label'>Товар *</label>
                            <select class='form-select' id='productId' name='product_id' required>
                                <option value=''>Выберите товар</option>
                                <?php foreach ($products as $product): ?>
                                    <option value='<?= $product['id'] ?>'><?= htmlspecialchars($product['name'] ?? '') ?></option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        <div class='col-md-6'>
                            <label class='form-label'>Рейтинг *</label>
                            <select class='form-select' id='rating' name='rating' required>
                                <option value=''>Выберите рейтинг</option>
                                <option value='5'>5 звезд - Отлично</option>
                                <option value='4'>4 звезды - Хорошо</option>
                                <option value='3'>3 звезды - Нормально</option>
                                <option value='2'>2 звезды - Плохо</option>
                                <option value='1'>1 звезда - Ужасно</option>
                            </select>
                        </div>
                    </div>
                    <div class='row mt-3'>
                        <div class='col-md-6'>
                            <label class='form-label'>Имя покупателя *</label>
                            <input type='text' class='form-control' id='customerName' name='customer_name' required>
                        </div>
                        <div class='col-md-6'>
                            <label class='form-label'>Email</label>
                            <input type='email' class='form-control' id='customerEmail' name='customer_email'>
                        </div>
                    </div>
                    <div class='mt-3'>
                        <label class='form-label'>Заголовок отзыва</label>
                        <input type='text' class='form-control' id='title' name='title' placeholder='Краткое описание впечатления'>
                    </div>
                    <div class='mt-3'>
                        <label class='form-label'>Текст отзыва *</label>
                        <textarea class='form-control' id='comment' name='comment' rows='4' required placeholder='Подробный отзыв о товаре'></textarea>
                    </div>
                    <div class='mt-3'>
                        <label class='form-label'>Статус</label>
                        <select class='form-select' id='status' name='status'>
                            <option value='pending'>На модерации</option>
                            <option value='approved'>Одобрен</option>
                            <option value='rejected'>Отклонен</option>
                        </select>
                    </div>
                </div>
                <div class='modal-footer'>
                    <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Отмена</button>
                    <button type='submit' class='btn btn-primary'>
                        <i class='fas fa-save me-2'></i>Сохранить отзыв
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Показать модальное окно для нового отзыва
function showReviewModal(reviewId = null) {
    document.getElementById('reviewModalTitle').textContent = reviewId ? 'Редактировать отзыв' : 'Добавить отзыв';
    document.getElementById('reviewForm').reset();

    if (reviewId) {
        loadReviewData(reviewId);
    } else {
        document.getElementById('reviewId').value = '';
    }

    new bootstrap.Modal(document.getElementById('reviewModal')).show();
}

// Загрузка данных отзыва для редактирования
async function loadReviewData(reviewId) {
    try {
        const formData = new FormData();
        formData.append('action', 'get_review');
        formData.append('id', reviewId);

        const response = await fetch('', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            const review = result.review;
            document.getElementById('reviewId').value = review.id || '';
            document.getElementById('productId').value = review.product_id || '';
            document.getElementById('rating').value = review.rating || '';
            document.getElementById('customerName').value = review.customer_name || '';
            document.getElementById('customerEmail').value = review.customer_email || '';
            document.getElementById('title').value = review.title || '';
            document.getElementById('comment').value = review.comment || '';
            document.getElementById('status').value = review.status || 'pending';
        } else {
            showNotification('Ошибка загрузки отзыва', 'error');
        }
    } catch (error) {
        console.error('Ошибка:', error);
        showNotification('Ошибка сети', 'error');
    }
}

// Редактирование отзыва
function editReview(reviewId) {
    showReviewModal(reviewId);
}

// Сохранение отзыва
document.getElementById('reviewForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    try {
        const formData = new FormData(this);
        formData.append('action', 'save_review');

        const response = await fetch('', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            showNotification(result.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(result.message, 'error');
        }
    } catch (error) {
        console.error('Ошибка:', error);
        showNotification('Ошибка сети', 'error');
    }
});

// Обновление статуса отзыва
async function updateStatus(reviewId, status) {
    if (!confirm('Изменить статус отзыва?')) return;

    try {
        const formData = new FormData();
        formData.append('action', 'update_review_status');
        formData.append('id', reviewId);
        formData.append('status', status);

        const response = await fetch('', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            showNotification(result.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(result.message, 'error');
        }
    } catch (error) {
        console.error('Ошибка:', error);
        showNotification('Ошибка сети', 'error');
    }
}

// Удаление отзыва
async function deleteReview(reviewId) {
    if (!confirm('Вы уверены, что хотите удалить этот отзыв? Это действие нельзя отменить.')) return;

    try {
        const formData = new FormData();
        formData.append('action', 'delete_review');
        formData.append('id', reviewId);

        const response = await fetch('', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            showNotification(result.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(result.message, 'error');
        }
    } catch (error) {
        console.error('Ошибка:', error);
        showNotification('Ошибка сети', 'error');
    }
}

// Фильтрация отзывов
function filterReviews() {
    const statusFilter = document.getElementById('statusFilter').value;
    const ratingFilter = document.getElementById('ratingFilter').value;
    const searchQuery = document.getElementById('searchInput').value.toLowerCase();

    const rows = document.querySelectorAll('.review-row');

    rows.forEach(row => {
        const status = row.dataset.status;
        const rating = row.dataset.rating;
        const searchText = row.dataset.search.toLowerCase();

        let show = true;

        if (statusFilter && status !== statusFilter) show = false;
        if (ratingFilter && rating !== ratingFilter) show = false;
        if (searchQuery && !searchText.includes(searchQuery)) show = false;

        row.style.display = show ? '' : 'none';
    });
}

// Уведомления
function showNotification(message, type = 'success') {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';

    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);';
    notification.innerHTML = `
        <i class='${icon} me-2'></i>${message}
        <button type='button' class='btn-close' data-bs-dismiss='alert'></button>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>
